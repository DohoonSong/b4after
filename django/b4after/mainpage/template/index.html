<!DOCTYPE HTML>
<!--
	Hyperspace by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>B4 & AFTER Final Project</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		{% load static %}

		<link rel="stylesheet" href="{% static 'assets/css/main.css' %}" />
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
		<!-- tensorflow javascript 모델 -->
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>

		<noscript><link rel="stylesheet" href="{% static 'assets/css/noscript.css' %}" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Loading 화면 코드 시작 -->
		<script src="https://code.jquery.com/jquery-1.8.0.js"
				integrity="sha256-00Fh8tkPAe+EmVaHFpD+HovxWk7b97qwqVi7nLvjdgs=" crossorigin="anonymous"></script>
		<script type="text/javascript">
			$(window).on('load', function () { $("#load").hide(); });
		</script>
		<style type="text/css">
			#load {
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				position: fixed;
				display: block;
				opacity: 0.8;
				background: white;
				z-index: 99;
				text-align: center;
			}
			#load > img {
				position: absolute;
				top: 50%;
				left: 50%;
				z-index: 100;
			}
		</style>
		<div id="load"> <img src="{% static 'images/icons8-loading-infinity.gif' %}" alt="loading"> </div> <!-- Loading 화면 코드 종료-->


		<!-- Sidebar -->
			<section id="sidebar">
				<div class="inner">
					<nav>
						<ul>
							<li><a href="#intro">ABOUT PROJECT</a></li>
							<li><a href="#one">Who we are</a></li>
							<li><a href="#two">Project Page</a></li>
							<li><a href="#three">Things To Do</a></li>
						</ul>
					</nav>
				</div>
			</section>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Intro -->
					<section id="intro" class="wrapper style1 fullscreen fade-up">
						<div class="inner">
							<h1>About B4 Team Project</h1>
							<p>Hello, welcome to our project. This project leads you to experience Fantastic hand motion tracking which can control KaKao map without any device. </p>
							<p><a href="https://map.kakao.com/">About Kakao map</a>.</p>
						</div>
					</section>

				<!-- One -->
					<section id="one" class="wrapper style2 spotlights">
						<section>
							<a href="#" class="image"><img src="{% static 'images/dohun.png' %}" alt="" data-position="center center" /></a>
							<div class="content">
								<div class="inner">
									<h2>Song Do Hoon</h2>
									<p>Team Leader of B4 & AFTER.</p>
								</div>
							</div>
						</section>
						<section>
							<a href="#" class="image"><img src="{% static 'images/JunYeop.jpg' %}" alt="" data-position="top center" /></a>
							<div class="content">
								<div class="inner">
									<h2>Lee Joon Yup</h2>
									<p>ML Engineer</p>
									<p> Likes to playing guitar</p>
								</div>
							</div>
						</section>
						<section>
							<a href="#" class="image"><img src="{% static 'images/sangin.jpg' %}" alt="" data-position="25% 25%" /></a>
							<div class="content">
								<div class="inner">
									<h2>Park Sang In</h2>
									<p>ML Engineer</p>
									<p>This project is working fine on my machine.. so, close the issue..</p>
								</div>
							</div>
						</section>
						<section>
							<a href="#" class="image"><img src="{% static 'images/Alin.png' %}" alt="" data-position="25% 25%" /></a>
							<div class="content">
								<div class="inner">
									<h2>Kim A Lin</h2>
									<p>ML Engineer</p>
								</div>
							</div>
						</section>
					</section>

				<!-- Two -->
					<section id="two" class="wrapper style3 fade-up">
						<div class="inner">
							<h2>Start Demo</h2>
							<p>Now, you can control our map API with your hand Gesture.</p>
							<div class="features">
								<section>
									<span class="icon solid major fa-code"></span>
									<h3>KaKao Map API</h3>
										<div id="map">
											<canvas class="map_canvas" width="250px" height="200px"></canvas>
										</div>
										<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=930d7dff7ef0e0911572002a7d811db9"></script>
										<script>
											function sleep(ms) {
												const wakeUpTime = Date.now() + ms;
												while (Date.now() < wakeUpTime) {}
											}
											//라벨 증가에 따른 i 값 증가를 위해 맨 처음에 선언
											var i = 0;

											var container = document.getElementById('map');
											var options = {
											center: new kakao.maps.LatLng(33.450701, 126.570667),
											level: 5
											};

											var map = new kakao.maps.Map(container, options);
											function zoomIn(map) {
												var curLevel = map.getLevel(); //확대 레벨
												map.setLevel(curLevel + 1, { //확대
													animate: {
													duration: 300
													}
												});
											}
											function zoomOut(map) {
												var curLevel = map.getLevel();
												map.setLevel(curLevel - 1, { //축소
													animate: {
													duration: 300
													}
												});
											}

											//Move 이동
											function moveMap(map, pointer) {
											//var curLoc = map.getCenter(); //중심 위치 (위도, 경도)
											// 지도 div width, height : offsetx, offsety (상대좌표 X)
											const map_offset = document.getElementById('map');

											// 포인터 상대..비율
											A_x = (pointer.x - 0.1) / 0.8;
											A_y = (pointer.y - 0.1) / 0.8;

											Cur_x = map_offset.offsetx * A_x;
											Cur_y = map_offset.offsety * A_y;

											//moveTo(Cur_x, Cur_y);
											var moveLatLon = new kakao.maps.LatLng(Cur_x, Cur_y);
											map.setCenter(moveLatLon);
											}

											//클릭
											kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
												var latLng = mouseEvent.latLng;
												marker.setPosition(latLng);
												var message = '클릭한 위치의 위도는 ' + latlng.getLat() + ' 이고, ';
												message += '경도는 ' + latlng.getLng() + ' 입니다';
												var resultDiv = document.getElementById('clickLatlng');
												resultDiv.innerHTML = message;
											});

											var arr_label = new Array();
											var pointer = {
												x : 10,
												y : 10,
											};
											while (false) {
											//result_label 및 result_pointer로 넘어온 값을 받고 array에 포함해 return. 추후 수정 필
											//var label = document.getElementById("result_label").value;
											// var pointer = document.getElementById('result_pointer').value;

												var label = "Move"
												switch (label) {
													case "Zoom In":
													zoomIn(map);
													console.log("label0")
													break;
													case "Zoom Out":
													zoomOut(map);
													console.log("label1")
													break;
													case "Move":
													moveMap(map, pointer);
													console.log("label2")
													break;
												}
												sleep(3000);
											}
										</script>
								</section>
								<section>
									<span class="icon solid major fa-code"></span>
									<h3>Your WEBCAM</h3>
									<video class="input_video" style="transform: rotateY(180deg);"></video>
									<canvas class="output_canvas" style="transform: rotateY(180deg);" width="500px" height="400px"></canvas>
									<script type="module">
										const videoElement = document.getElementsByClassName('input_video')[0];
										const canvasElement = document.getElementsByClassName('output_canvas')[0];
										const canvasCtx = canvasElement.getContext('2d');

										 // tensorflow lite model loading / 모델 경로
										const keypoint_model = await tf.loadLayersModel('{% static "model/model.json" %}');
										const gesture_model = await tf.loadLayersModel('{% static "model/model_point.json" %}');
										console.log(keypoint_model.name, gesture_model.name, ": model logged successfully");
										let point_history = [];
										//

										// results parsing 하는 부분.
										function json2tensor(results){
											var point = tf.tensor([]);
											console.log("multi", results.multiHandLandmarks[0]);
											const flattenLayer = tf.layers.flatten();
											for (const landmarks of results.multiHandLandmarks[0]) {
												point = tf.concat([point,tf.tensor([landmarks.x,landmarks.y])]);
											}
											point = tf.reshape(point,[1,42]);
											//console.log("json2", point);
											//point = flattenLayer.apply(point);
											return point;
										}
										function json3tensor(ll){
											var point = tf.tensor([]);
											const flattenLayer = tf.layers.flatten();
											for (const landmarks of ll) {
												point = tf.concat([point,tf.tensor([landmarks[0],landmarks[1]])]);
											}
											point = tf.reshape(point,[1,ll.length * 2]);
											// console.log("json3", point);
											return point;
										}
										function calc_landmark_list(landmarks){
											const image_width = 1280;
											const image_height = 720;

											var landmark_point = [];
											//console.log(landmarks[0]);
											if (landmarks.length <= 0){
												return landmark_point;
											}
											landmarks[0].forEach(function(landmark){
												var x = Math.min(parseInt(landmark.x * image_width), image_width - 1);
												var y = Math.min(parseInt(landmark.y * image_height), image_height - 1);

												landmark_point.push([x, y]);
											});
											//console.log("calc success", landmark_point.length);
											return landmark_point;
										}
										function pre_process_landmark(landmark_list){
											var tmp = landmark_list.slice();
											if(!tmp.length){
												return tmp;
											}
											var base_x = 0;
											var base_y = 0;
											var idx = 0;
											for(var landmark_point of tmp){
												if (idx == 0) {
													base_x = landmark_point[0];
													base_y = landmark_point[1];
												}

												tmp[idx][0] = landmark_point[0] - base_x;
												tmp[idx][1] = landmark_point[1] - base_y;
												idx++;
											}
											//console.log("tmp set", tmp.length, tmp);
											var ftmp = tmp.flat();
											for(var i=0;i<ftmp.length;i++){
												ftmp[i] = Math.abs(ftmp[i]);
											}
											var max_value = Math.max(...ftmp);
											//console.log()
											tmp.forEach(function(n){
												return n / max_value;
											});
											//console.log("pre_process success", tmp.length, tmp, max_value);
											return tmp;
										}

										function pre_process_point_history(point_history_list) {
											const image_width = 1280;
											const image_height = 720;
											var tmp = point_history_list.slice();
											if(!tmp.length){
												return tmp;
											}
											var base_x = 0;
											var base_y = 0;
											var idx = 0;
											for(var point of tmp){
												if (idx == 0) {
													base_x = point[0];
													base_y = point[1];
												}
												tmp[idx][0] = (point[0] - base_x) / image_width;
												tmp[idx][1] = (point[1] - base_y) / image_height;
											}

											return tmp;
										}
										var key_labels = [
											"open",
											"close",
											"okay",
											"pointer1",
											"pointer2",
											"smile",
										];
										var point_labels = [
											"None",
											"Zoom Out",
											"Zoom In",
											"Move",
										];
										function onResults(results) {
										  canvasCtx.save();
										  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
										  canvasCtx.drawImage(
											  results.image, 0, 0, canvasElement.width, canvasElement.height);
										  if (results.multiHandLandmarks) {
											var landmark_ = calc_landmark_list(results.multiHandLandmarks);
											var pre_processed_landmark_list = pre_process_landmark(landmark_);
											var pre_processed_point_history_list = pre_process_point_history(point_history);
											for (const landmarks of results.multiHandLandmarks) {
											  drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS,
															 {color: '#fffdfd', lineWidth: 1.5});
											  drawLandmarks(canvasCtx, landmarks, {color: '#444350', lineWidth: 2});
											}
											if (results.multiHandLandmarks[0]){
												//const predictionArray = model.predict(json2tensor(results)).dataSync();
												//json2tensor(results);
												//json3tensor(pre_processed_landmark_list);
												const predictionArray = keypoint_model.predict(json3tensor(pre_processed_landmark_list)).dataSync();
												var max_Value = predictionArray.indexOf(Math.max(...predictionArray));


												point_history.push(landmark_[4])
												point_history.push(landmark_[8])



												let point_history_len = pre_processed_point_history_list.length;
												let history_length = 16

												if (point_history.length > (history_length * 2)) {
													let cnt = point_history.length - (history_length * 2);
													point_history = point_history.slice(cnt);
												}
												//console.log(key_labels[max_Value], point_history_len, point_history.length);
												if (point_history_len == (history_length * 2)){
													const predictionArray2 = gesture_model.predict(json3tensor(pre_processed_point_history_list)).dataSync();
													var max_gesture = predictionArray2.indexOf(Math.max(...predictionArray2));
													var point_label = point_labels[max_gesture];
													switch (point_label) {
													case "Zoom In":
														zoomIn(map);
														console.log("Zoom In");
														break;
													case "Zoom Out":
														zoomOut(map);
														console.log("Zoom Out");
														break;
													case "Move":
														moveMap(map, pointer);
														console.log("move");
														break;
													case "None":
														console.log("None");
														break;
													default:
														console.log("another", point_label);
														break;
													}

													//console.log(max_gesture);
												}

											};
										  }
										  canvasCtx.restore();
										}

										const hands = new Hands({locateFile: (file) => {
										  return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
										}});
										hands.setOptions({
										  maxNumHands: 2,
										  minDetectionConfidence: 0.8,
										  minTrackingConfidence: 0.5
										});
										hands.onResults(onResults);

										const camera = new Camera(videoElement, {
										  onFrame: async () => {
											await hands.send({image: videoElement});
										  },
										  width: 500,
										  height: 400
										});
										camera.start();
										</script>
								</section>
							</div>

							<ul class="actions">
								<li><a href="generic.html" class="button">Learn more</a></li>
							</ul>
						</div>
					</section>

				<!-- Three -->
					<section id="three" class="wrapper style1 fade-up">
						<div class="inner">
							<h2>Get in touch</h2>
							<p>Contact us with any issue.</p>
							<div class="split style1">
								<section>
									<form method="post" action="#">
										<div class="fields">
											<div class="field half">
												<label for="name">Name</label>
												<input type="text" name="name" id="name" />
											</div>
											<div class="field half">
												<label for="email">Email</label>
												<input type="text" name="email" id="email" />
											</div>
											<div class="field">
												<label for="message">Message</label>
												<textarea name="message" id="message" rows="5"></textarea>
											</div>
										</div>
										<ul class="actions">
											<li><a href="" class="button submit">Send Message</a></li>
										</ul>
									</form>
								</section>
								<section>
									<ul class="contact">
										<li>
											<h3>Address</h3>
											<span>12345 Somewhere Road #654<br />
											Nashville, TN 00000-0000<br />
											USA</span>
										</li>
										<li>
											<h3>Email</h3>
											<a href="#">user@untitled.tld</a>
										</li>
										<li>
											<h3>Phone</h3>
											<span>(000) 000-0000</span>
										</li>
										<li>
											<h3>Social</h3>
											<ul class="icons">
												<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
												<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
												<li><a href="#" class="icon brands fa-github"><span class="label">GitHub</span></a></li>
												<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
												<li><a href="#" class="icon brands fa-linkedin-in"><span class="label">LinkedIn</span></a></li>
											</ul>
										</li>
									</ul>
								</section>
							</div>
						</div>
					</section>

			</div>

		<!-- Footer -->
			<footer id="footer" class="wrapper style1-alt">
				<div class="inner">
					<ul class="menu">
						<li>&copy; Untitled. All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
					</ul>
				</div>
			</footer>

		<!-- Scripts -->
			<script src="{% static 'assets/js/jquery.min.js' %}"></script>
			<script src="{% static 'assets/js/jquery.scrollex.min.js' %}"></script>
			<script src="{% static 'assets/js/jquery.scrolly.min.js' %}"></script>
			<script src="{% static 'assets/js/browser.min.js' %}"></script>
			<script src="{% static 'assets/js/breakpoints.min.js' %}"></script>
			<script src="{% static 'assets/js/util.js' %}"></script>
			<script src="{% static 'assets/js/main.js' %}"></script>

	</body>
</html>